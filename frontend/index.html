<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>POD Creator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark light" />
<meta name="description" content="Print-on-demand store creator for DevMode" />
<style>
  /* Dark mode (default) - CYBER HIGH-TECH */
  :root {
    --fg:#e0e0ff;
    --muted:#8888aa;
    --accent:#00d9ff;
    --accent-glow:rgba(0,217,255,0.3);
    --border:#2a2a44;
    --ok:#00ff88;
    --bad:#ff4466;
    --bg:#0a0a14;
    --panel-bg:linear-gradient(135deg, #111122 0%, #1a1a2e 100%);
    --input-bg:#16162a;
    --btn-bg:linear-gradient(135deg, #1a1a2e 0%, #252544 100%);
    --btn-active:linear-gradient(135deg, #00d9ff 0%, #0099ff 100%);
    --grid-header:#16162e;
  }

  /* Light mode */
  body[data-theme="light"] {
    --fg:#111;
    --muted:#777;
    --accent:#0066cc;
    --accent-glow:rgba(0,102,204,0.2);
    --border:#d7d7e7;
    --ok:#0a7a2f;
    --bad:#b40000;
    --bg:#f5f5fa;
    --panel-bg:linear-gradient(135deg, #fff 0%, #f8f8fc 100%);
    --input-bg:#fff;
    --btn-bg:linear-gradient(135deg, #fff 0%, #f5f5f9 100%);
    --btn-active:linear-gradient(135deg, #0066cc 0%, #0099ff 100%);
    --grid-header:#e8e8f0;
  }

  * { box-sizing: border-box; }
  body { 
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace, system-ui; 
    margin: 24px; 
    color: var(--fg); 
    background: var(--bg);
    transition: background 0.3s, color 0.3s;
  }
  h1 { font-size: 24px; margin: 0 0 12px; letter-spacing: 2px; text-transform: uppercase; }
  h2 { font-size: 16px; margin: 0 0 8px; letter-spacing: 1px; }
  .topbar { display:flex; gap:12px; align-items:center; margin-bottom: 16px; flex-wrap: wrap; }
  .inline { display:inline-flex; align-items:center; gap:8px; }
  select, input, textarea { font: inherit; color: var(--fg); }
  .select, .input, .textarea { 
    padding: 8px 12px; 
    border:2px solid var(--border); 
    border-radius:8px; 
    background:var(--input-bg);
    transition: all 0.2s;
  }
  .select:focus, .input:focus, .textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 12px var(--accent-glow);
    outline: none;
  }
  .tabs { display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap; }
  .tab { 
    padding:10px 16px; 
    border:2px solid var(--border); 
    border-radius:8px; 
    cursor:pointer; 
    background:var(--btn-bg);
    transition: all 0.2s;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    font-size: 12px;
  }
  .tab:hover {
    border-color: var(--accent);
    box-shadow: 0 0 12px var(--accent-glow);
  }
  .tab.active { 
    background:var(--btn-active); 
    color:#fff; 
    border-color:var(--accent);
    box-shadow: 0 0 16px var(--accent-glow);
  }
  .grid { width: 100%; border-collapse: collapse; }
  .grid th {
    background: var(--grid-header);
    border-bottom: 2px solid var(--accent);
    padding: 12px 8px;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: background 0.2s;
  }
  .grid th[style*="cursor:pointer"]:hover {
    background: var(--panel-bg);
    box-shadow: inset 0 0 12px var(--accent-glow);
  }
  .grid td { 
    border-bottom: 1px solid var(--border); 
    padding: 12px 8px; 
    font-size: 13px; 
    vertical-align: top;
  }
  .grid tr { background: var(--panel-bg); }
  .grid tr:hover { 
    background: var(--panel-bg);
    box-shadow: inset 0 0 20px var(--accent-glow);
  }
  .panel { 
    border:2px solid var(--border); 
    border-radius:12px; 
    padding:20px; 
    margin-bottom:16px; 
    background:var(--panel-bg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  .row { display:grid; grid-template-columns:1fr 400px; gap:16px; }
  .btn { 
    padding:10px 16px; 
    border:2px solid var(--border); 
    border-radius:8px; 
    cursor:pointer; 
    background:var(--btn-bg); 
    color:var(--fg);
    transition: all 0.2s;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .btn:hover { 
    background:var(--btn-active); 
    color:#fff; 
    border-color:var(--accent);
    box-shadow: 0 0 16px var(--accent-glow), inset 0 0 16px rgba(255,255,255,0.1);
    transform: translateY(-1px);
  }
  .btn:active, .btn.active {
    background:var(--btn-active);
    color:#fff;
    border-color:var(--accent);
    box-shadow: 0 0 20px var(--accent-glow), inset 0 0 20px rgba(255,255,255,0.2);
    transform: translateY(0);
  }
  .btn + .btn { margin-left:8px; }
  .good { color:var(--ok); font-weight:700; text-shadow: 0 0 8px var(--ok); }
  .bad { color:var(--bad); font-weight:700; text-shadow: 0 0 8px var(--bad); }
  .muted { color:var(--muted); }
  .kbd { 
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
    font-size: 12px; 
    background:var(--input-bg); 
    padding:3px 8px; 
    border-radius:6px; 
    border:2px solid var(--border);
  }
  canvas { 
    background-image: linear-gradient(45deg,#1a1a2e 25%,transparent 25%),linear-gradient(-45deg,#1a1a2e 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#1a1a2e 75%),linear-gradient(-45deg,transparent 75%,#1a1a2e 75%);
    background-size:20px 20px; 
    background-position:0 0,0 10px,10px -10px,-10px 0px; 
    border-radius: 8px;
    border: 2px solid var(--border);
    box-shadow: 0 0 16px var(--accent-glow);
  }
  body[data-theme="light"] canvas { 
    background-image: linear-gradient(45deg,#e8e8f0 25%,transparent 25%),linear-gradient(-45deg,#e8e8f0 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#e8e8f0 75%),linear-gradient(-45deg,transparent 75%,#e8e8f0 75%); 
  }
  .toast { 
    position: fixed; 
    right:16px; 
    bottom:16px; 
    background:var(--accent); 
    color:#fff; 
    padding:12px 18px; 
    border-radius:8px; 
    display:none; 
    box-shadow:0 8px 30px var(--accent-glow), 0 0 20px var(--accent-glow);
    font-weight: 600;
    border: 2px solid var(--accent);
  }
  .help { font-size: 13px; color: var(--muted); }
  .split { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .pill { 
    font-size:11px; 
    padding:6px 12px; 
    border:2px solid var(--border); 
    border-radius:999px; 
    background:var(--btn-bg); 
    display:inline-block;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }
  .theme-toggle { 
    cursor:pointer; 
    padding:8px; 
    border-radius:8px; 
    border:2px solid var(--border); 
    background:var(--btn-bg);
    transition: all 0.2s;
  }
  .theme-toggle:hover { 
    background:var(--accent); 
    border-color:var(--accent);
    box-shadow: 0 0 12px var(--accent-glow);
  }
  .footer { margin-top:24px; font-size:12px; color:var(--muted); }
  
  /* Preview dimension display */
  .preview-info {
    margin-top: 12px;
    padding: 12px;
    background: var(--panel-bg);
    border: 2px solid var(--border);
    border-radius: 8px;
    font-size: 13px;
    font-family: 'JetBrains Mono', monospace;
    display: none;
  }
  .preview-info.active {
    display: block;
  }
  .preview-info .dim-label {
    color: var(--accent);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 11px;
  }
  .preview-info .dim-value {
    color: var(--fg);
    font-weight: 600;
    font-size: 16px;
  }
</style>
</head>
<body>
  <div class="topbar">
    <h1 style="margin-right:8px;">POD Creator</h1>
    <span class="pill" style="background:#111;color:#fff;font-weight:600;" id="versionBadge">Loading...</span>
    <label class="inline">
      <span class="muted">App:</span>
      <select id="appSelect" class="select">
        <option value="devmode-asset-checker">DevMode Asset Checker</option>
        <option value="wescale-pod-console">WeScale POD Console</option>
      </select>
    </label>
    <button id="btnCheckUpdates" class="btn" title="Checks your repo for updates">Check for Updates</button>
    <button id="btnThemeToggle" class="theme-toggle" title="Toggle dark/light mode">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
        <path d="M6 .278a.768.768 0 0 1 .08.858 7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
      </svg>
    </button>
    <span id="updateStatus" class="muted"></span>
    <div class="inline" style="margin-left:auto;">
      <span class="muted">Store:</span>
      <span id="currentStoreName" class="pill" style="font-weight:600;">No Store Loaded</span>
      <button id="btnLoadStore" class="btn" title="Load store configuration">Load Store</button>
      <button id="btnExportStore" class="btn" title="Export current store configuration">Export Store</button>
    </div>
  </div>
  <div style="margin-bottom:16px;">
    <span class="pill">Style A: DevMode 105px Â· Slogan 400px Â· #FFF Â· Transparent Â· Left-aligned</span>
  </div>

  <div class="tabs" id="tabs"></div>
  <div id="content"></div>
  <div id="toast" class="toast"></div>

<script>
/* =========================
   VERSION - CHANGE ONLY HERE!
   ========================= */
const VERSION = '1.0.20';

/* =========================
   Configuration
   ========================= */
console.log('POD Creator JavaScript is loading...');
const LOCAL_VERSION = VERSION; // For backwards compatibility with update checker
console.log('POD Creator v' + VERSION + ' loaded successfully!');

// Update page title and badge with version
document.title = `POD Creator - v${VERSION}`;
// Update badge immediately when script runs (after badge element exists in DOM)
setTimeout(() => {
  const badge = document.getElementById('versionBadge');
  if (badge) badge.textContent = `v${VERSION}`;
}, 0);
const UPDATE_URL = 'https://raw.githubusercontent.com/dquillman/POD-Store-Creator/main/frontend/updates.json';
// Backend API URL - will be auto-detected from Cloud Run or can be set manually
const API_URL = window.location.hostname === 'storage.googleapis.com'
  ? 'https://pod-creator-api-508544473305.us-central1.run.app'
  : 'http://localhost:8081';

/* =========================
   API Helper
   ========================= */
async function apiCall(endpoint, options = {}) {
  const url = `${API_URL}${endpoint}`;

  // Include store credentials in headers if available
  const storeHeaders = {};
  if (currentStore) {
    if (currentStore.shopifyStore) storeHeaders['X-Shopify-Store'] = currentStore.shopifyStore;
    if (currentStore.shopifyAccessToken) storeHeaders['X-Shopify-Token'] = currentStore.shopifyAccessToken;
    if (currentStore.printfulApiKey) storeHeaders['X-Printful-Key'] = currentStore.printfulApiKey;
    if (currentStore.openaiApiKey) storeHeaders['X-OpenAI-Key'] = currentStore.openaiApiKey;
  }

  try {
    const res = await fetch(url, {
      ...options,
      headers: {
        'Content-Type': 'application/json',
        ...storeHeaders,
        ...options.headers
      }
    });
    const json = await res.json();
    if (!json.ok && json.error) throw new Error(json.error);
    return json;
  } catch (error) {
    console.error(`API call failed: ${endpoint}`, error);
    throw error;
  }
}

/* =========================
   Update channel (optional)
   ========================= */

async function checkForUpdates(){
  const s = document.getElementById('updateStatus'); s.textContent = 'Checkingâ€¦';
  try{
    const res = await fetch(UPDATE_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('No updates file');
    const j = await res.json();
    const remote = j.schemaVersion || '0.0.0';
    if(remote !== LOCAL_VERSION){ toast('Update available: ' + remote); s.textContent = 'Update available: ' + remote; }
    else { s.textContent = 'Up to date'; toast('You are up to date.'); }
  }catch{ s.textContent = 'Couldnâ€™t check.'; }
}
document.getElementById('btnCheckUpdates').onclick = checkForUpdates;

// Theme toggle
function initTheme() {
  const savedTheme = localStorage.getItem('pod-creator-theme') || 'dark';
  if (savedTheme === 'light') {
    document.body.setAttribute('data-theme', 'light');
  }
}

function toggleTheme() {
  const currentTheme = document.body.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  if (newTheme === 'light') {
    document.body.setAttribute('data-theme', 'light');
  } else {
    document.body.removeAttribute('data-theme');
  }
  localStorage.setItem('pod-creator-theme', newTheme);
  toast(newTheme === 'dark' ? 'Dark mode enabled' : 'Light mode enabled');
}

document.getElementById('btnThemeToggle').onclick = toggleTheme;
initTheme();

/* =========================
   Store Management
   ========================= */
let currentStore = null;

// Initialize store from localStorage
function initStore() {
  const savedStore = localStorage.getItem('pod-creator-store');
  if (savedStore) {
    try {
      currentStore = JSON.parse(savedStore);
      updateStoreDisplay();
    } catch (e) {
      console.error('Failed to load saved store:', e);
    }
  }
}

function updateStoreDisplay() {
  const nameEl = document.getElementById('currentStoreName');
  if (currentStore) {
    nameEl.textContent = currentStore.name || currentStore.shopifyStore || 'Store Loaded';
    nameEl.style.background = 'var(--accent)';
    nameEl.style.color = '#fff';
  } else {
    nameEl.textContent = 'No Store Loaded';
    nameEl.style.background = 'var(--btn-bg)';
    nameEl.style.color = 'var(--fg)';
  }
}

// Load store configuration from JSON file
function loadStore() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const config = JSON.parse(text);

      // Validate required fields
      if (!config.shopifyStore || !config.shopifyAccessToken) {
        toast('Invalid store config: Missing shopifyStore or shopifyAccessToken');
        return;
      }

      currentStore = config;
      localStorage.setItem('pod-creator-store', JSON.stringify(config));
      updateStoreDisplay();
      toast(`Store "${config.name || config.shopifyStore}" loaded successfully!`);
    } catch (err) {
      toast('Failed to load store config: ' + err.message);
      console.error(err);
    }
  };
  input.click();
}

// Export current store configuration
function exportStore() {
  if (!currentStore) {
    toast('No store to export. Load a store first.');
    return;
  }

  const json = JSON.stringify(currentStore, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentStore.name || currentStore.shopifyStore || 'store'}-config.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Store configuration exported!');
}

// Get current store credentials for API calls
function getStoreCredentials() {
  return currentStore || {};
}

document.getElementById('btnLoadStore').onclick = loadStore;
document.getElementById('btnExportStore').onclick = exportStore;
initStore();

/* =========================
   Specs for both tools
   ========================= */
const SPEC_DEVMODE = {
  appId:"devmode-asset-checker", title:"DevMode Asset Checker",
  tabs:[
    {id:"asset-audit",label:"Asset Audit"},
    {id:"store-setup",label:"Store Setup Flow"},
    {id:"settings",label:"Settings"}
  ]
};
const SPEC_POD = {
  appId:"wescale-pod-console", title:"WeScale POD Console",
  tabs:[
    {id:"asset-audit",label:"Asset Audit"},
    {id:"tshirt-designer",label:"T-Shirt Designer"},
    {id:"niche",label:"Step 1 Â· Niche Research"},
    {id:"selector",label:"Mini-Audit"},
    {id:"brand",label:"Step 2â€“4 Â· Brand & Logo"},
    {id:"design-research",label:"Step 5 Â· Design Research"},
    {id:"design-generator",label:"Step 6 Â· Design Generator"},
    {id:"qa-export",label:"QA & Export"}
  ]
};
const SPEC_MAP = { [SPEC_DEVMODE.appId]:SPEC_DEVMODE, [SPEC_POD.appId]:SPEC_POD };
let spec = SPEC_DEVMODE;

/* =========================
   UI helpers
   ========================= */
function el(tag, attrs={}, children=[]){ const e=document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{ if(k==='class') e.className=v; else if(k==='html') e.innerHTML=v; else if(k.startsWith('on')) e[k]=v; else e.setAttribute(k,v);});
  (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c));
  return e;
}
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); }

/* =========================
   State (Asset Checker)
   ========================= */
let files=[], checks=[], settings={
  fontSizeDevMode:105,
  fontSizeSlogan:400,
  lineHeight:1.15,
  maxBgDelta:12,
  // Style A Heuristic settings
  styleA_whiteTolerance: 16,
  styleA_minWhitePixels: 100,
  styleA_scanWidth: 800,
  styleA_scanHeight: 400,
  styleA_requireTransparency: true,
  styleA_requireNoBg: true
};
let sortColumn = null, sortAscending = true;

/* =========================
   Render shell
   ========================= */
document.getElementById('appSelect').onchange = e => { spec = SPEC_MAP[e.target.value]; render(); };
render();

function render(){
  const tabsEl = document.getElementById('tabs'); const content=document.getElementById('content');
  tabsEl.innerHTML=''; content.innerHTML='';
  spec.tabs.forEach((t,i)=>{ const btn = el('div',{class:'tab'+(i===0?' active':''),'data-idx':i},t.label); btn.onclick=()=>switchTab(i); tabsEl.appendChild(btn); });
  switchTab(0);
}
async function switchTab(idx){
  [...document.querySelectorAll('.tab')].forEach((n,i)=>n.classList.toggle('active',i===idx));
  const tab = spec.tabs[idx]; const content=document.getElementById('content'); content.innerHTML='';
  if(spec.appId==='devmode-asset-checker'){
    if(tab.id==='asset-audit') content.appendChild(renderAuditTab());
    if(tab.id==='store-setup') content.appendChild(await renderStoreTab());
    if(tab.id==='settings') content.appendChild(renderSettingsTab());
  }else if(spec.appId==='wescale-pod-console'){
    // Asset Audit and T-Shirt Designer are available in POD Console
    if(tab.id==='asset-audit') content.appendChild(renderAuditTab());
    else if(tab.id==='tshirt-designer') content.appendChild(renderTShirtDesigner());
    else content.appendChild(renderPODScaffold());
  }
}

/* =========================
   DevMode Asset Checker
   ========================= */
let localgridWrap=null;

function renderAuditTab(){
  const row = el('div',{class:'row'});
  // Create localGridWrap first
  const localGridWrap = el('div',{style:'margin-top:12px;'});
  /* localGridWrap = localGridWrap; // Assign to global*/

  // Left
  const left = el('div',{class:'panel'},[
    el('h2',{},'Upload & Inspect'),
    el('div',{},[
      (()=>{ const lbl=el('label',{class:'btn',style:'display:inline-block;'},'Upload PNGs');
        const input=el('input',{type:'file',multiple:true,accept:'.png',style:'display:none;'});
        lbl.onclick=()=>input.click();
        input.onchange=async e=>{ files=[...e.target.files]; checks=[]; await runChecks(); renderGrid(localGridWrap); };
        return el('div',{},[lbl,input]); })(),
      el('span',{class:'help',style:'margin-left:8px;'},'Tip: hold '),
      el('span',{class:'kbd'},'Shift'),
      el('span',{class:'help'},' to select multiple files.')
    ]),
    el('div',{style:'margin-top:8px;'},[
      el('button',{class:'btn',onclick:async()=>{ await runChecks(); renderGrid(localGridWrap); }},'Run Checks')
    ]),
    localGridWrap
  ]);
  // Right
  const right = el('div',{class:'panel'},[
    el('h2',{},'Preview'),
    el('canvas',{id:'previewCanvas',width:600,height:720}),
    el('div',{id:'previewInfo',class:'preview-info'},''),
    el('div',{class:'help',style:'margin-top:8px;'},
      'Style A: DevMode 105px Â· Slogan 400px Â· #FFFFFF Â· transparent Â· left-aligned Â· no extra effects.')
  ]);
  row.append(left,right); renderGrid(localGridWrap); return row;
}

function sortChecks(column) {
  if (sortColumn === column) {
    sortAscending = !sortAscending;
  } else {
    sortColumn = column;
    sortAscending = true;
  }

  const sortedChecks = [...checks];

  sortedChecks.sort((a, b) => {
    let aVal, bVal;

    switch(column) {
      case 'file':
        aVal = a.name.toLowerCase();
        bVal = b.name.toLowerCase();
        break;
      case 'transparency':
        aVal = a.hasTransparency ? 1 : 0;
        bVal = b.hasTransparency ? 1 : 0;
        break;
      case 'background':
        aVal = a.bgLikely ? 1 : 0;
        bVal = b.bgLikely ? 1 : 0;
        break;
      case 'dimensions':
        aVal = a.width * a.height;
        bVal = b.width * b.height;
        break;
      case 'styleA':
        aVal = a.styleAOk ? 1 : 0;
        bVal = b.styleAOk ? 1 : 0;
        break;
      default:
        return 0;
    }

    if (aVal < bVal) return sortAscending ? -1 : 1;
    if (aVal > bVal) return sortAscending ? 1 : -1;
    return 0;
  });

  checks = sortedChecks;
}

function renderGrid(container){

  const wrap=el('div');
  const table=el('table',{class:'grid'});

  // Create sortable headers
  const headers = [
    {label: 'File', column: 'file'},
    {label: 'Transparency', column: 'transparency'},
    {label: 'Background Detected', column: 'background'},
    {label: 'Dimensions', column: 'dimensions'},
    {label: 'Style A Heuristic', column: 'styleA'},
    {label: 'Actions', column: null}
  ];

  const headRow = el('tr');
  headers.forEach(h => {
    const sortIndicator = sortColumn === h.column ? (sortAscending ? ' â–²' : ' â–¼') : '';
    const th = el('th', {
      style: h.column ? 'cursor:pointer;user-select:none;' : '',
      onclick: h.column ? () => { sortChecks(h.column); renderGrid(container); } : null
    }, h.label + sortIndicator);
    headRow.appendChild(th);
  });

  table.appendChild(el('thead',{},headRow));
  const body=el('tbody');
  checks.forEach((r,idx)=>{
    
    const tr=el('tr',{},[
      el('td',{},r.name),
      el('td',{},el('span',{class:r.hasTransparency?'good':'bad'},r.hasTransparency?'Yes':'No')),
      el('td',{},el('span',{class:r.bgLikely?'bad':'good'},r.bgLikely?'Yes':'No')),
      el('td',{},el('div',{},[`${r.width}Ã—${r.height}`,el('br'),el('span',{class:r.sizeOk?'good':'bad'},r.sizeOk?'âœ“ OK':'âœ— Need 4500Ã—5400')])),
      el('td',{},el('span',{class:r.styleAOk?'good':'bad'},r.styleAOk?'OK':'Check')),
      el('td',{},[
        el('button',{class:'btn',onclick:()=>{preview(idx)}},'Preview'),
        el('button',{class:'btn',onclick:()=>removeBG(idx,'white')},'Remove BG (white)'),
        el('button',{class:'btn',onclick:()=>removeBG(idx,'black')},'Remove BG (black)'),
        el('button',{class:'btn',onclick:()=>exportPNG(idx)},'Export Clean'),
        el('button',{class:'btn',onclick:()=>resizeImage(idx)},'Resize to 4500Ã—5400'),
      ])
    ]);
    body.appendChild(tr);
  });
  table.appendChild(body);
  wrap.appendChild(table);
  container.replaceChildren(wrap);
}

async function runChecks(){
  checks = await Promise.all(files.map(async f=>{
    const img = await readImage(f); const meta = await analyze(img);
    return { name:f.name, file:f, ...meta, _img:img };
  }));
}
function readImage(file){ return new Promise(res=>{ const url=URL.createObjectURL(file); const img=new Image(); img.onload=()=>res(img); img.src=url; }); }

async function analyze(img){
  const w=img.naturalWidth, h=img.naturalHeight;
  const c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d'); x.drawImage(img,0,0);
  const d=x.getImageData(0,0,w,h).data; const sample=(sx,sy)=>{ const i=(sy*w+sx)*4; return [d[i],d[i+1],d[i+2],d[i+3]]; };

  const sizeOk=(w===4500 && h===5400);

  // Transparency and border-opaque sampling â†’ background heuristic
  let alpha=0, borderOpaque=0, borderSamples=0;
  const stepX=Math.max(1,Math.floor(w/200)), stepY=Math.max(1,Math.floor(h/200));
  for(let x0=0;x0<w;x0+=stepX){ [[x0,0],[x0,h-1]].forEach(([sx,sy])=>{ borderSamples++; if(sample(sx,sy)[3]>0) borderOpaque++; }); }
  for(let y0=0;y0<h;y0+=stepY){ [[0,y0],[w-1,y0]].forEach(([sx,sy])=>{ borderSamples++; if(sample(sx,sy)[3]>0) borderOpaque++; }); }
  for(let y=0;y<h;y+=stepY){ for(let x1=0;x1<w;x1+=stepX){ const a=sample(x1,y)[3]; if(a===0) alpha++; } }

  const hasTransparency = alpha>0;
  const bgLikely = (borderOpaque/borderSamples)>0.5;

  // Style A check: uses customizable settings
  const tol = settings.styleA_whiteTolerance;
  const scanW = Math.min(settings.styleA_scanWidth, w);
  const scanH = Math.min(settings.styleA_scanHeight, h);
  let whitePix = 0;

  for(let y=0; y<scanH; y+=8){
    for(let x2=0; x2<scanW; x2+=8){
      const [r,g,b,a]=sample(x2,y);
      if(a>0 && Math.abs(255-r)<tol && Math.abs(255-g)<tol && Math.abs(255-b)<tol) whitePix++;
    }
  }

  // Check against configurable criteria
  let styleAOk = true;
  if(settings.styleA_requireTransparency && !hasTransparency) styleAOk = false;
  if(settings.styleA_requireNoBg && bgLikely) styleAOk = false;
  if(whitePix < settings.styleA_minWhitePixels) styleAOk = false;

  return { hasTransparency, bgLikely, sizeOk, styleAOk, width: w, height: h };
}
let activePreviewIdx = -1;

function preview(idx){
  try {
    const row=checks[idx];
    if (!row || !row._img) {
      toast('Error: Image not loaded. Try running checks first.');
      return;
    }
    const cvs=document.getElementById('previewCanvas');
    if (!cvs) {
      toast('Error: Preview canvas not found');
      return;
    }
    
    // Update active button state
    activePreviewIdx = idx;
    document.querySelectorAll('.grid .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    const ctx=cvs.getContext('2d');
    ctx.clearRect(0,0,cvs.width,cvs.height);

    // Fill with checkerboard pattern to show transparency
    const tileSize = 20;
    for (let y = 0; y < cvs.height; y += tileSize) {
      for (let x = 0; x < cvs.width; x += tileSize) {
        ctx.fillStyle = ((x / tileSize) + (y / tileSize)) % 2 === 0 ? '#e0e0e0' : '#f5f5f5';
        ctx.fillRect(x, y, tileSize, tileSize);
      }
    }

    const ratio=Math.min(cvs.width/row._img.naturalWidth,cvs.height/row._img.naturalHeight);
    const w=Math.round(row._img.naturalWidth*ratio), h=Math.round(row._img.naturalHeight*ratio);
    const x = Math.round((cvs.width - w) / 2);
    const y = Math.round((cvs.height - h) / 2);
    ctx.drawImage(row._img, x, y, w, h);

    // Update preview info with dimensions
    const previewInfo = document.getElementById('previewInfo');
    if (previewInfo) {
      const origDim = `${row.width}Ã—${row.height}`;
      const targetDim = '4500Ã—5400';
      const sizeMatch = row.sizeOk ? 'MATCH' : 'NEED RESIZE';
      previewInfo.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <div class="dim-label">ORIGINAL</div>
            <div class="dim-value">${origDim}</div>
          </div>
          <div>
            <div class="dim-label">TARGET</div>
            <div class="dim-value">${targetDim}</div>
          </div>
        </div>
        <div style="margin-top:12px;padding-top:12px;border-top:2px solid var(--border);">
          <div class="dim-label">STATUS</div>
          <div class="dim-value" style="color:${row.sizeOk ? 'var(--ok)' : 'var(--bad)'};">${sizeMatch}</div>
        </div>
      `;
      previewInfo.classList.add('active');
    }

    toast(`Previewing: ${row.name}`);
  } catch (e) {
    console.error('Preview error:', e);
    toast('Error previewing image: ' + e.message);
  }
}

function removeBG(idx,mode='white'){
  const row=checks[idx]; const w=row._img.naturalWidth, h=row._img.naturalHeight;
  const c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d'); x.drawImage(row._img,0,0);
  const imgd=x.getImageData(0,0,w,h); const d=imgd.data; const fuzz=settings.maxBgDelta||12;
  const isWhite=(r,g,b)=>r>=255-fuzz&&g>=255-fuzz&&b>=255-fuzz;
  const isBlack=(r,g,b)=>r<=fuzz&&g<=fuzz&&b<=fuzz;
  for(let i=0;i<d.length;i+=4){
    const r=d[i],g=d[i+1],b=d[i+2],a=d[i+3];
    if(a===0) continue;
    if(mode==='white'&&isWhite(r,g,b)) d[i+3]=0;
    if(mode==='black'&&isBlack(r,g,b)) d[i+3]=0;
  }
  x.putImageData(imgd,0,0);
  const url=c.toDataURL('image/png'); const img=new Image(); img.onload=()=>{ checks[idx]._img=img; preview(idx); render(); }; img.src=url;
}

function exportPNG(idx){
  const row=checks[idx];
  const c=document.createElement('canvas'); c.width=row._img.naturalWidth; c.height=row._img.naturalHeight;
  c.getContext('2d').drawImage(row._img,0,0);
  const a=document.createElement('a'); a.download=row.name.replace(/\.png$/i,'_clean.png'); a.href=c.toDataURL('image/png'); a.click();
}


async function resizeImage(idx){
  const row=checks[idx];
  const img=row._img;
  const c=document.createElement('canvas');
  c.width=4500;
  c.height=5400;
  const ctx=c.getContext('2d');
  
  // Calculate scaling to fit image within 4500x5400 while maintaining aspect ratio
  const scale=Math.min(4500/img.naturalWidth, 5400/img.naturalHeight);
  const scaledW=Math.round(img.naturalWidth*scale);
  const scaledH=Math.round(img.naturalHeight*scale);
  const offsetX=Math.round((4500-scaledW)/2);
  const offsetY=Math.round((5400-scaledH)/2);
  
  // Draw image centered on canvas
  ctx.drawImage(img, offsetX, offsetY, scaledW, scaledH);
  
  // Convert to blob and trigger download
  c.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.download=row.name.replace(/\.png$/i,'_4500x5400.png');
    a.href=url;
    a.click();
    URL.revokeObjectURL(url);
    toast(`Resized ${row.name} to 4500Ã—5400`);
  }, 'image/png');
}
/* =========================
   Store Setup (checklist)
   ========================= */
let storeStatus = null;

async function loadStoreStatus() {
  try {
    const res = await fetch('../store_status_report.json');
    if (res.ok) {
      storeStatus = await res.json();
      return storeStatus;
    }
  } catch (e) {
    console.log('No store_status_report.json found. Run: npm run check-status');
  }
  return null;
}

function checkStepCompletion(stepId, status) {
  if (!status) return false;

  // Map each step to file/data validation
  switch(stepId) {
    case 0: // Lock DevMode Style A
      return status.environment?.configured && status.assets?.artworks > 0;

    case 1: // Generate & approve slogans
      return status.assets?.artworks >= 40; // Artworks exist

    case 2: // Batch export transparent PNGs
      return status.assets?.artworks >= 40; // Check for sufficient artwork files

    case 3: // Create PDP mockups
      return status.assets?.mockups >= 5; // Check mockup files

    case 4: // Create listings
      return status.csvFiles?.shopifyProducts === true; // CSV generated

    case 5: // SEO pass
      return status.csvFiles?.shopifyProducts === true; // Included in CSV

    case 6: // Pricing & profit check
      return status.csvFiles?.shopifyProducts === true; // Pricing in CSV

    case 7: // Publish to storefronts
      return status.csvFiles?.printfulMapping === true; // Ready to publish

    case 8: // Final QA
      return false; // Manual QA always pending until manually checked

    default:
      return false;
  }
}

async function renderStoreTab(){
  const status = await loadStoreStatus();

  const steps = [
    { label: "Lock DevMode Style A (font sizes, spacing)", hint: "Configure store settings and environment" },
    { label: "Generate & approve slogans", hint: "Create artwork files in /artworks folder" },
    { label: "Batch export transparent PNGs 4500Ã—5400", hint: "Export high-res PNG files" },
    { label: "Create PDP mockups (dark tees + hoodies)", hint: "Generate mockup images in /mockups folder" },
    { label: "Create listings (title, bullets, tags)", hint: "Run: npm run gen-csv" },
    { label: "SEO pass (keywords, alt text)", hint: "Review CSV file for SEO fields" },
    { label: "Pricing & profit check ($28â€“$35 tees)", hint: "Verify pricing in CSV" },
    { label: "Publish to storefronts", hint: "Run: npm run setup to publish" },
    { label: "Final QA: thumbnail contrast, readability", hint: "Manual final review" }
  ];

  const key='pod-creator-store-flow';
  const saved = JSON.parse(localStorage.getItem(key)||'{}');

  // Stats section
  const statsDiv = el('div', {style:'display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;'});
  if (status) {
    const statCard = (label, value, color='var(--accent)') =>
      el('div', {style:`padding:12px;border:1px solid var(--border);border-radius:8px;text-align:center;`}, [
        el('div', {style:`font-size:24px;font-weight:700;color:${color};`}, String(value)),
        el('div', {style:'font-size:12px;color:var(--muted);margin-top:4px;'}, label)
      ]);

    statsDiv.appendChild(statCard('Artworks', status.assets?.artworks || 0, '#3b82f6'));
    statsDiv.appendChild(statCard('Mockups', status.assets?.mockups || 0, '#8b5cf6'));
    statsDiv.appendChild(statCard('Brand Assets', status.assets?.brand || 0, '#ec4899'));
  }

  const list = el('div', {style:'margin-top:16px;'});
  steps.forEach((step, i) => {
    const id = 's' + i;
    const manualCheck = !!saved[id];
    const autoDetected = checkStepCompletion(i, status);
    const isComplete = manualCheck || autoDetected;

    const checkbox = el('input', {
      type: 'checkbox',
      checked: isComplete ? 'checked' : null,
      onchange: (e) => {
        saved[id] = e.target.checked;
        localStorage.setItem(key, JSON.stringify(saved));
        renderStoreTab().then(newContent => {
          document.getElementById('content').innerHTML = '';
          document.getElementById('content').appendChild(newContent);
        });
      }
    });

    const statusIndicator = autoDetected
      ? el('span', {style:'color:#10b981;font-size:14px;margin-left:auto;'}, 'âœ“ Auto-detected')
      : manualCheck
      ? el('span', {style:'color:#3b82f6;font-size:14px;margin-left:auto;'}, 'âœ“ Manual')
      : el('span', {style:'color:var(--muted);font-size:14px;margin-left:auto;'}, 'â—‹ Pending');

    const row = el('div', {
      style: `display:flex;align-items:flex-start;gap:12px;padding:12px;margin:8px 0;border:1px solid ${isComplete ? '#10b981' : 'var(--border)'};border-radius:8px;background:${isComplete ? 'rgba(16,185,129,0.05)' : 'transparent'};cursor:pointer;`
    }, [
      checkbox,
      el('div', {style:'flex:1;'}, [
        el('div', {style:'font-weight:600;margin-bottom:4px;'}, step.label),
        el('div', {style:'font-size:12px;color:var(--muted);'}, step.hint)
      ]),
      statusIndicator
    ]);

    row.onclick = (e) => {
      if (e.target !== checkbox) checkbox.click();
    };

    list.appendChild(row);
  });

  // Action buttons
  const actions = el('div', {style:'margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;'}, [
    el('button', {
      class: 'btn',
      style: 'background:var(--ok);color:#fff;',
      onclick: async () => {
        toast('Running status check...');
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'â³ Running npm run check-status...';

        try {
          // Call backend to run the npm script
          const result = await fetch(`${API_URL}/api/run-check-status`, {
            method: 'POST'
          });
          const data = await result.json();

          if (data.ok) {
            toast('âœ… Status check complete!');
            // Reload the store status
            await loadStoreStatus();
            const newContent = await renderStoreTab();
            document.getElementById('content').innerHTML = '';
            document.getElementById('content').appendChild(newContent);
          } else {
            toast('âŒ Check failed: ' + data.error);
          }
        } catch (error) {
          toast('âŒ Error: ' + error.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'â–¶ï¸ Run Check Status';
        }
      }
    }, 'â–¶ï¸ Run Check Status'),
    el('button', {
      class: 'btn',
      style: 'background:var(--accent);color:#fff;',
      onclick: async () => {
        toast('Refreshing store status...');
        await loadStoreStatus();
        const newContent = await renderStoreTab();
        document.getElementById('content').innerHTML = '';
        document.getElementById('content').appendChild(newContent);
        toast('Store status refreshed!');
      }
    }, 'ðŸ”„ Refresh Status'),
    el('button', {
      class: 'btn',
      onclick: () => {
        const completed = steps.filter((s, i) => checkStepCompletion(i, status) || saved['s'+i]).length;
        const total = steps.length;
        const pct = Math.round((completed / total) * 100);
        toast(`Progress: ${completed}/${total} steps (${pct}%)`);
      }
    }, 'ðŸ“Š Show Progress')
  ]);

  return el('div', {class:'panel'}, [
    el('h2', {}, 'Store Setup Flow'),
    status ? statsDiv : el('div', {class:'help', style:'margin-bottom:16px;background:#fef3c7;color:#92400e;padding:12px;border-radius:8px;'},
      'Click the Run Check Status button below to auto-detect completion status'),
    list,
    actions,
    el('div', {class:'help', style:'margin-top:12px;'},
      'Steps are auto-detected from your files. Manual checks are saved in browser localStorage.')
  ]);
}

/* =========================
   Settings
   ========================= */
function renderSettingsTab(){
  const container = el('div', {style:'display:flex;flex-direction:column;gap:16px;'});

  // General Settings Panel
  const generalPanel = el('div',{class:'panel'},[
    el('h2',{},'General Settings'),
    labeled('DevMode font size (px)', String(settings.fontSizeDevMode), v=>settings.fontSizeDevMode=Number(v)),
    labeled('Slogan font size (px)', String(settings.fontSizeSlogan), v=>settings.fontSizeSlogan=Number(v)),
    labeled('Line height (em)', String(settings.lineHeight), v=>settings.lineHeight=Number(v)),
    labeled('BG detect tolerance (0-255)', String(settings.maxBgDelta), v=>settings.maxBgDelta=Number(v)),
    el('div',{class:'help',style:'margin-top:6px;'},'Note: PNGs do not reliably store DPI; 4500x5400 px is interpreted as 300 DPI at print.')
  ]);

  // Style A Heuristic Panel
  const styleAPanel = el('div',{class:'panel'},[
    el('h2',{},'Style A Heuristic Settings'),
    el('div',{class:'help',style:'margin-bottom:12px;'},'Customize how the Style A check validates your designs. Click Recheck All after changing settings.'),

    el('h3',{style:'font-size:14px;margin:16px 0 8px;font-weight:600;'},'White Pixel Detection'),
    labeled('White color tolerance (0-255)', String(settings.styleA_whiteTolerance), v=>settings.styleA_whiteTolerance=Number(v)),
    el('div',{class:'help',style:'margin-left:268px;margin-top:-4px;margin-bottom:8px;'},'Lower = stricter white detection. 0 = pure #FFFFFF only, 16 = slight gray allowed'),

    labeled('Min white pixels required', String(settings.styleA_minWhitePixels), v=>settings.styleA_minWhitePixels=Number(v)),
    el('div',{class:'help',style:'margin-left:268px;margin-top:-4px;margin-bottom:8px;'},'How many white pixels must be found in scan region'),

    el('h3',{style:'font-size:14px;margin:16px 0 8px;font-weight:600;'},'Scan Region (from top-left)'),
    labeled('Scan width (px)', String(settings.styleA_scanWidth), v=>settings.styleA_scanWidth=Number(v)),
    labeled('Scan height (px)', String(settings.styleA_scanHeight), v=>settings.styleA_scanHeight=Number(v)),
    el('div',{class:'help',style:'margin-left:268px;margin-top:-4px;margin-bottom:8px;'},'Area to check for white pixels. Default: 800Ã—400 (top-left region)'),

    el('h3',{style:'font-size:14px;margin:16px 0 8px;font-weight:600;'},'Requirements'),
    labeledCheckbox('Require transparency', settings.styleA_requireTransparency, v=>settings.styleA_requireTransparency=v),
    labeledCheckbox('Require no background detected', settings.styleA_requireNoBg, v=>settings.styleA_requireNoBg=v),

    el('div',{style:'margin-top:16px;display:flex;gap:8px;'},[
      el('button',{class:'btn',style:'background:var(--accent);color:#fff;',onclick:recheckAll},'ðŸ”„ Recheck All Files'),
      el('button',{class:'btn',onclick:resetStyleADefaults},'â†º Reset to Defaults')
    ])
  ]);

  container.appendChild(generalPanel);
  container.appendChild(styleAPanel);
  return container;

  function labeled(label,value,onchange){
    const input = el('input',{class:'input',value,style:'width:140px;'});
    input.onchange = e=>onchange(e.target.value);
    return el('div',{style:'margin:8px 0;display:flex;align-items:center;gap:8px;'},
      [ el('div',{style:'width:260px;'},label), input ]);
  }

  function labeledCheckbox(label,checked,onchange){
    const checkbox = el('input',{type:'checkbox',checked:checked?'checked':null,style:'width:20px;height:20px;cursor:pointer;'});
    checkbox.onchange = e=>onchange(e.target.checked);
    return el('div',{style:'margin:8px 0;display:flex;align-items:center;gap:8px;'},
      [ el('div',{style:'width:260px;'},label), checkbox ]);
  }

  async function recheckAll(){
    if(files.length === 0){
      toast('No files to recheck. Upload files first.');
      return;
    }
    await runChecks();
    const gridWrap = document.querySelector('#content .panel .row > div:first-child > div:last-child');
    if(gridWrap) renderGrid(gridWrap);
    toast('All files rechecked with new settings!');
  }

  function resetStyleADefaults(){
    settings.styleA_whiteTolerance = 16;
    settings.styleA_minWhitePixels = 100;
    settings.styleA_scanWidth = 800;
    settings.styleA_scanHeight = 400;
    settings.styleA_requireTransparency = true;
    settings.styleA_requireNoBg = true;
    toast('Reset to default Style A settings');
    switchTab(2); // Re-render settings tab
  }
}

/* =========================
   POD Console (full implementation)
   ========================= */
let podData = { trends: [], prompts: [], mockups: [], listings: [] };

function renderPODScaffold(){
  return el('div',{},[
    el('div',{class:'panel'},[
      el('h2',{},'POD Workflow Console'),
      el('div',{class:'help'},'Complete workflow: Research â†’ Design â†’ Mockups â†’ Listings â†’ Publish')
    ]),

    // Research Section
    el('div',{class:'split',style:'margin-top:12px;'},[
      el('div',{class:'panel'},[
        el('h2',{},'1. Design Research'),
        el('div',{class:'help'},'Generate trending design ideas for your niche'),
        el('div',{style:'margin:8px 0;'},[
          el('label',{},'Niche: '),
          el('input',{id:'nicheInput',class:'input',value:'developer',style:'width:200px;margin-left:8px;'})
        ]),
        el('button',{class:'btn',onclick:generateTrends},'Generate Trends'),
        el('div',{id:'trendsOutput',style:'margin-top:12px;'})
      ]),
      el('div',{class:'panel'},[
        el('h2',{},'2. Design Prompts'),
        el('div',{class:'help'},'Create specific t-shirt design prompts'),
        el('div',{style:'margin:8px 0;'},[
          el('label',{},'Style: '),
          el('select',{id:'styleInput',class:'select',style:'margin-left:8px;'},[
            el('option',{value:'minimalist'},'Minimalist'),
            el('option',{value:'retro'},'Retro'),
            el('option',{value:'bold'},'Bold'),
            el('option',{value:'funny'},'Funny')
          ])
        ]),
        el('button',{class:'btn',onclick:generatePrompts},'Generate Prompts'),
        el('div',{id:'promptsOutput',style:'margin-top:12px;'})
      ])
    ]),

    // Mockups & Listings Section
    el('div',{class:'split',style:'margin-top:12px;'},[
      el('div',{class:'panel'},[
        el('h2',{},'3. Generate Mockups'),
        el('div',{class:'help'},'Create product mockups from your designs'),
        el('div',{style:'margin:8px 0;'},[
          el('label',{},'Image URL: '),
          el('input',{id:'mockupImageUrl',class:'input',placeholder:'https://...',style:'width:100%;margin-top:4px;'})
        ]),
        el('button',{class:'btn',onclick:generateMockup},'Create Mockup'),
        el('div',{id:'mockupOutput',style:'margin-top:12px;'})
      ]),
      el('div',{class:'panel'},[
        el('h2',{},'4. Create Listing'),
        el('div',{class:'help'},'Build Shopify product listing'),
        el('div',{style:'margin:8px 0;'},[
          el('label',{},'Title: '),
          el('input',{id:'listingTitle',class:'input',placeholder:'Product title',style:'width:100%;margin-top:4px;'}),
          el('label',{style:'margin-top:8px;'},'Price: '),
          el('input',{id:'listingPrice',class:'input',value:'29.99',style:'width:100px;margin-left:8px;'})
        ]),
        el('button',{class:'btn',onclick:createListing},'Create Listing'),
        el('div',{id:'listingOutput',style:'margin-top:12px;'})
      ])
    ]),

    // Publish Section
    el('div',{class:'panel',style:'margin-top:12px;'},[
      el('h2',{},'5. Publish Product'),
      el('div',{class:'help'},'Publish draft product to your store'),
      el('div',{style:'margin:8px 0;'},[
        el('label',{},'Listing ID: '),
        el('input',{id:'publishListingId',class:'input',placeholder:'From step 4',style:'width:200px;margin-left:8px;'})
      ]),
      el('button',{class:'btn',onclick:publishProduct},'Publish to Store'),
      el('div',{id:'publishOutput',style:'margin-top:12px;'})
    ]),

    // Store Status Upload
    el('div',{class:'panel',style:'margin-top:12px;'},[
      el('h2',{},'Store Status Check'),
      el('div',{class:'help'},'Upload store_status_report.json from your local checker'),
      el('div',{style:'margin:8px 0;'},[
        (()=>{
          const lbl=el('label',{class:'btn',style:'display:inline-block;'},'Upload Status Report');
          const input=el('input',{type:'file',accept:'.json',style:'display:none;'});
          lbl.onclick=()=>input.click();
          input.onchange=async e=>{ await uploadStoreStatus(e.target.files[0]); };
          return el('div',{},[lbl,input]);
        })()
      ]),
      el('div',{id:'statusOutput',style:'margin-top:12px;'})
    ])
  ]);
}

// Generate Trends
async function generateTrends(){
  const niche = document.getElementById('nicheInput').value || 'developer';
  const output = document.getElementById('trendsOutput');
  output.innerHTML = 'Loading...';

  try {
    const result = await apiCall('/api/trends', {
      method: 'POST',
      body: JSON.stringify({ niche, keywords: [] })
    });

    podData.trends = result.trends || [];
    const list = el('ol',{style:'margin:8px 0;padding-left:20px;'});
    result.trends.forEach(t => list.appendChild(el('li',{style:'margin:4px 0;'},t)));
    output.innerHTML = '';
    output.appendChild(el('div',{class:'good',style:'margin-bottom:8px;'},'âœ“ Generated ' + result.trends.length + ' trends'));
    output.appendChild(list);
    toast('Trends generated!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

// Generate Prompts
async function generatePrompts(){
  const niche = document.getElementById('nicheInput').value || 'developer';
  const style = document.getElementById('styleInput').value || 'minimalist';
  const output = document.getElementById('promptsOutput');
  output.innerHTML = 'Loading...';

  try {
    const result = await apiCall('/api/prompts', {
      method: 'POST',
      body: JSON.stringify({ niche, style, count: 10 })
    });

    podData.prompts = result.prompts || [];
    const list = el('ol',{style:'margin:8px 0;padding-left:20px;font-size:13px;'});
    result.prompts.forEach(p => list.appendChild(el('li',{style:'margin:6px 0;'},p)));
    output.innerHTML = '';
    output.appendChild(el('div',{class:'good',style:'margin-bottom:8px;'},'âœ“ Generated ' + result.prompts.length + ' prompts'));
    output.appendChild(list);
    toast('Prompts generated!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

// Generate Mockup
async function generateMockup(){
  const imageUrl = document.getElementById('mockupImageUrl').value;
  const output = document.getElementById('mockupOutput');

  if (!imageUrl) {
    toast('Please enter an image URL');
    return;
  }

  output.innerHTML = 'Generating mockup... (this may take 10-20 seconds)';

  try {
    const result = await apiCall('/api/mockup', {
      method: 'POST',
      body: JSON.stringify({ imageUrl, productId: 71, variantId: 4012 })
    });

    podData.mockups = result.mockups || [];
    output.innerHTML = '';
    output.appendChild(el('div',{class:'good',style:'margin-bottom:8px;'},'âœ“ Mockup generated'));

    if (result.mockups && result.mockups.length > 0) {
      result.mockups.forEach(m => {
        output.appendChild(el('img',{src:m.url,style:'max-width:200px;margin:8px;border:1px solid #ddd;border-radius:4px;'}));
      });
    }

    if (result.message) {
      output.appendChild(el('div',{class:'help',style:'margin-top:8px;'},result.message));
    }

    toast('Mockup ready!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

// Create Listing
async function createListing(){
  const title = document.getElementById('listingTitle').value;
  const price = parseFloat(document.getElementById('listingPrice').value) || 29.99;
  const output = document.getElementById('listingOutput');

  if (!title) {
    toast('Please enter a product title');
    return;
  }

  output.innerHTML = 'Creating listing...';

  try {
    const images = podData.mockups.map(m => m.url);
    const result = await apiCall('/api/listing', {
      method: 'POST',
      body: JSON.stringify({
        title,
        description: `${title} - High quality print-on-demand apparel`,
        tags: ['devmode', 'developer', 'coding'],
        price,
        images
      })
    });

    output.innerHTML = '';
    output.appendChild(el('div',{class:'good',style:'margin-bottom:8px;'},'âœ“ Listing created'));
    output.appendChild(el('div',{},[
      el('strong',{},'Listing ID: '),
      el('span',{},result.listingId)
    ]));

    if (result.adminUrl) {
      output.appendChild(el('div',{style:'margin-top:8px;'},[
        el('a',{href:result.adminUrl,target:'_blank',class:'btn'},'View in Shopify Admin')
      ]));
    }

    if (result.message) {
      output.appendChild(el('div',{class:'help',style:'margin-top:8px;'},result.message));
    }

    document.getElementById('publishListingId').value = result.listingId;
    toast('Listing created!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

// Publish Product
async function publishProduct(){
  const listingId = document.getElementById('publishListingId').value;
  const output = document.getElementById('publishOutput');

  if (!listingId) {
    toast('Please enter a listing ID');
    return;
  }

  output.innerHTML = 'Publishing...';

  try {
    const result = await apiCall('/api/publish', {
      method: 'POST',
      body: JSON.stringify({ listingId })
    });

    output.innerHTML = '';
    output.appendChild(el('div',{class:'good',style:'margin-bottom:8px;'},'âœ“ Product published!'));

    if (result.url) {
      output.appendChild(el('div',{style:'margin-top:8px;'},[
        el('strong',{},'Store URL: '),
        el('a',{href:result.url,target:'_blank'},result.url)
      ]));
    }

    if (result.adminUrl) {
      output.appendChild(el('div',{style:'margin-top:8px;'},[
        el('a',{href:result.adminUrl,target:'_blank',class:'btn'},'View in Shopify Admin')
      ]));
    }

    if (result.message) {
      output.appendChild(el('div',{class:'help',style:'margin-top:8px;'},result.message));
    }

    toast('Product is live!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

// Upload Store Status
async function uploadStoreStatus(file){
  if (!file) return;

  const output = document.getElementById('statusOutput');
  output.innerHTML = 'Analyzing...';

  try {
    const text = await file.text();
    const report = JSON.parse(text);

    const result = await apiCall('/api/store-status', {
      method: 'POST',
      body: JSON.stringify(report)
    });

    const analysis = result.analysis;
    output.innerHTML = '';

    output.appendChild(el('div',{class:'good',style:'margin-bottom:12px;'},'âœ“ Report analyzed'));
    output.appendChild(el('div',{style:'font-size:16px;font-weight:600;margin-bottom:8px;'},[
      el('span',{},'Completion: '),
      el('span',{class:analysis.completionPercentage >= 80 ? 'good' : 'bad'},analysis.completionPercentage + '%')
    ]));

    if (analysis.missingSteps.length > 0) {
      output.appendChild(el('div',{style:'margin-top:12px;'},[
        el('strong',{},'Missing Steps:'),
        el('ul',{style:'margin:8px 0;padding-left:20px;'},
          analysis.missingSteps.map(s => el('li',{},s))
        )
      ]));
    }

    if (analysis.recommendations.length > 0) {
      output.appendChild(el('div',{style:'margin-top:12px;'},[
        el('strong',{},'Recommendations:'),
        el('ul',{style:'margin:8px 0;padding-left:20px;'},
          analysis.recommendations.map(r => el('li',{},r))
        )
      ]));
    }

    if (analysis.readyForLaunch) {
      output.appendChild(el('div',{class:'good',style:'margin-top:12px;font-weight:600;'},'ðŸŽ‰ Your store is ready to launch!'));
    }

    toast('Store status analyzed!');
  } catch (error) {
    output.innerHTML = '';
    output.appendChild(el('div',{class:'bad'},'Error: ' + error.message));
  }
}

/* =========================
   T-Shirt Designer
   ========================= */

// T-Shirt Designer State
let tshirtState = {
  collection: "Persona Patterns",
  designQueue: [
    { id: "devmode-001", title: "DevMode â€” Bold Contrast", brand: "DevMode", aspect: "2000Ã—2000", bg: "transparent", model: "female", status: "ready" },
    { id: "persona-ENFP-002", title: "Persona Patterns â€” ENFP Sunburst", brand: "Persona Patterns", aspect: "2000Ã—2000", bg: "transparent", model: "male", status: "ready" },
    { id: "persona-INTJ-003", title: "Persona Patterns â€” INTJ Monoline", brand: "Persona Patterns", aspect: "2000Ã—2000", bg: "transparent", model: "female", status: "queued" }
  ],
  activeDesign: "devmode-001",
  prompt: "T-shirt graphic: 'DevMode' headline with supporting phrase in smaller type. Clean sans-serif, high contrast.",
  negativePrompt: "no gradients, no busy textures, avoid tiny unreadable text",
  preset: "bold-contrast",
  bg: "transparent",
  model: "rotate",
  size: "2000Ã—2000",
  lighting: 75,
  whitePoint: 92,
  autoZip: true,
  running: false,
  progress: 0,
  previewTab: "front"
};

const tshirtPresets = [
  { id: "bold-contrast", name: "Bold Contrast News Cut", desc: "High-contrast headline + subline" },
  { id: "mono-min", name: "Mono Minimal", desc: "Clean, centered logo mark" },
  { id: "retro-tech", name: "Retro Tech", desc: "Bitmap halftone grid, neon hint" },
  { id: "persona-grid", name: "Persona Grid", desc: "MBTI block layout, crisp" }
];

const bgOptions = [
  { id: "transparent", label: "Transparent" },
  { id: "office", label: "Tech Office" },
  { id: "home", label: "Home Workspace" },
  { id: "studio", label: "Studio Gray" }
];

const sizes = ["2000Ã—2000", "3000Ã—3000", "4500Ã—5400 (Printful)"];
const variants = ["Black Tee", "White Tee", "Heather Gray", "Navy", "Athletic Fit", "Relaxed Fit"];

let batchInterval = null;

function renderTShirtDesigner() {
  const container = el('div', { style: 'width:100%;' });

  // Main layout
  const mainGrid = el('div', { style: 'display:grid;grid-template-columns:repeat(12,1fr);gap:16px;' });

  // Left column: Presets & Queue
  const leftCol = el('div', { style: 'grid-column:span 3;display:flex;flex-direction:column;gap:16px;' });
  leftCol.appendChild(renderPresetsPanel());
  leftCol.appendChild(renderQueuePanel());

  // Center column: Prompt Builder & Batch Controls
  const centerCol = el('div', { style: 'grid-column:span 5;display:flex;flex-direction:column;gap:16px;' });
  centerCol.appendChild(renderPromptBuilder());
  centerCol.appendChild(renderBatchControls());

  // Right column: Preview & Variants
  const rightCol = el('div', { style: 'grid-column:span 4;display:flex;flex-direction:column;gap:16px;' });
  rightCol.appendChild(renderPreviewPanel());
  rightCol.appendChild(renderVariantsPanel());

  mainGrid.appendChild(leftCol);
  mainGrid.appendChild(centerCol);
  mainGrid.appendChild(rightCol);

  container.appendChild(mainGrid);
  return container;
}

function renderPresetsPanel() {
  const panel = el('div', { class: 'panel' }, [
    el('h2', {}, 'Presets'),
    el('div', { id: 'tshirt-presets-list', style: 'display:flex;flex-direction:column;gap:8px;' })
  ]);

  const presetsList = panel.querySelector('#tshirt-presets-list');
  tshirtPresets.forEach(p => {
    const isActive = tshirtState.preset === p.id;
    const presetBtn = el('button', {
      class: 'btn',
      style: `text-align:left;padding:12px;border:${isActive ? '2px solid var(--accent)' : '1px solid var(--border)'};background:${isActive ? 'var(--accent)' : 'var(--btn-bg)'};color:${isActive ? '#fff' : 'var(--fg)'};`
    }, [
      el('div', {}, [
        el('div', { style: 'font-weight:600;margin-bottom:4px;' }, p.name),
        el('div', { style: 'font-size:11px;opacity:0.7;' }, p.desc)
      ])
    ]);
    presetBtn.onclick = () => {
      tshirtState.preset = p.id;
      refreshTShirtUI();
    };
    presetsList.appendChild(presetBtn);
  });

  return panel;
}

function renderQueuePanel() {
  const panel = el('div', { class: 'panel' }, [
    el('h2', {}, 'Queue'),
    el('div', { id: 'tshirt-queue-list', style: 'display:flex;flex-direction:column;gap:8px;max-height:400px;overflow-y:auto;' })
  ]);

  const queueList = panel.querySelector('#tshirt-queue-list');
  tshirtState.designQueue.forEach(d => {
    const isActive = tshirtState.activeDesign === d.id;
    const queueItem = el('div', {
      style: `padding:8px;border:${isActive ? '2px solid var(--accent)' : '1px solid var(--border)'};border-radius:8px;background:${isActive ? 'var(--panel-bg)' : 'transparent'};cursor:pointer;`
    }, [
      el('div', { style: 'display:flex;align-items:center;gap:8px;' }, [
        el('div', { style: 'width:40px;height:40px;border-radius:8px;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:20px;' }, 'ðŸŽ¨'),
        el('div', { style: 'flex:1;min-width:0;' }, [
          el('div', { style: 'font-weight:600;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;' }, d.title),
          el('div', { style: 'font-size:11px;color:var(--muted);' }, `${d.aspect} â€¢ ${d.bg} â€¢ ${d.model}`)
        ]),
        el('span', { class: 'pill', style: `background:${d.status === 'ready' ? 'var(--ok)' : 'var(--muted)'};color:#fff;font-size:11px;padding:2px 8px;` }, d.status)
      ])
    ]);
    queueItem.onclick = () => {
      tshirtState.activeDesign = d.id;
      refreshTShirtUI();
    };
    queueList.appendChild(queueItem);
  });

  // Footer with buttons
  const footer = el('div', { style: 'margin-top:12px;display:flex;justify-content:space-between;gap:8px;' }, [
    el('button', { class: 'btn', style: 'flex:1;' }, 'ðŸ—‘ï¸ Clear queued'),
    el('button', { class: 'btn', style: 'flex:1;background:var(--accent);color:#fff;' }, 'âž• New')
  ]);
  footer.children[0].onclick = () => {
    tshirtState.designQueue = tshirtState.designQueue.filter(d => d.status === 'ready');
    refreshTShirtUI();
    toast('Queued designs cleared');
  };
  footer.children[1].onclick = () => {
    const id = `custom-${Date.now()}`;
    const title = `${tshirtState.collection} â€” ${tshirtPresets.find(p => p.id === tshirtState.preset)?.name || 'Custom'}`;
    tshirtState.designQueue.unshift({
      id, title,
      brand: tshirtState.collection,
      aspect: tshirtState.size,
      bg: tshirtState.bg,
      model: tshirtState.model,
      status: 'queued'
    });
    tshirtState.activeDesign = id;
    refreshTShirtUI();
    toast('Added to queue');
  };

  panel.appendChild(footer);
  return panel;
}

function renderPromptBuilder() {
  const panel = el('div', { class: 'panel' }, [
    el('h2', {}, 'Prompt Builder'),
    el('div', { style: 'display:flex;flex-direction:column;gap:12px;' }, [
      el('div', {}, [
        el('label', { style: 'font-weight:600;display:block;margin-bottom:4px;' }, 'Positive Prompt'),
        el('textarea', {
          id: 'tshirt-prompt',
          style: 'width:100%;min-height:96px;padding:8px;background:var(--input-bg);color:var(--fg);border:1px solid var(--border);border-radius:8px;font-family:inherit;'
        })
      ]),
      el('div', {}, [
        el('label', { style: 'font-weight:600;display:block;margin-bottom:4px;' }, 'Negative Prompt'),
        el('textarea', {
          id: 'tshirt-negative-prompt',
          style: 'width:100%;min-height:72px;padding:8px;background:var(--input-bg);color:var(--fg);border:1px solid var(--border);border-radius:8px;font-family:inherit;'
        })
      ]),
      el('div', { style: 'display:grid;grid-template-columns:repeat(3,1fr);gap:12px;' }, [
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Background'),
          el('select', { id: 'tshirt-bg', style: 'width:100%;padding:6px;background:var(--input-bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;' },
            bgOptions.map(o => el('option', { value: o.id }, o.label))
          )
        ]),
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Model'),
          el('select', { id: 'tshirt-model', style: 'width:100%;padding:6px;background:var(--input-bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;' }, [
            el('option', { value: 'female' }, 'Female'),
            el('option', { value: 'male' }, 'Male'),
            el('option', { value: 'rotate' }, 'Rotate'),
            el('option', { value: 'none' }, 'None')
          ])
        ]),
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Canvas Size'),
          el('select', { id: 'tshirt-size', style: 'width:100%;padding:6px;background:var(--input-bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;' },
            sizes.map(s => el('option', { value: s }, s))
          )
        ])
      ]),
      el('div', { style: 'display:grid;grid-template-columns:repeat(2,1fr);gap:12px;' }, [
        el('div', {}, [
          el('div', { style: 'display:flex;justify-content:space-between;margin-bottom:4px;' }, [
            el('label', { style: 'font-weight:600;font-size:12px;' }, 'Lighting'),
            el('span', { id: 'tshirt-lighting-val', style: 'font-size:12px;color:var(--muted);' }, tshirtState.lighting + '%')
          ]),
          el('input', { id: 'tshirt-lighting', type: 'range', min: '0', max: '100', value: tshirtState.lighting, style: 'width:100%;' })
        ]),
        el('div', {}, [
          el('div', { style: 'display:flex;justify-content:space-between;margin-bottom:4px;' }, [
            el('label', { style: 'font-weight:600;font-size:12px;' }, 'White Point'),
            el('span', { id: 'tshirt-whitepoint-val', style: 'font-size:12px;color:var(--muted);' }, tshirtState.whitePoint + '%')
          ]),
          el('input', { id: 'tshirt-whitepoint', type: 'range', min: '0', max: '100', value: tshirtState.whitePoint, style: 'width:100%;' })
        ])
      ]),
      el('div', { style: 'margin-top:16px;' }, [
        el('button', {
          id: 'tshirt-generate-single',
          class: 'btn',
          style: 'width:100%;background:var(--ok);color:#fff;padding:12px;font-weight:600;font-size:14px;'
        }, 'ðŸŽ¨ Generate This Design Now')
      ])
    ])
  ]);

  // Set values and wire up events
  setTimeout(() => {
    const promptEl = document.getElementById('tshirt-prompt');
    const negativePromptEl = document.getElementById('tshirt-negative-prompt');
    const bgEl = document.getElementById('tshirt-bg');
    const modelEl = document.getElementById('tshirt-model');
    const sizeEl = document.getElementById('tshirt-size');
    const lightingEl = document.getElementById('tshirt-lighting');
    const whitepointEl = document.getElementById('tshirt-whitepoint');

    if (promptEl) promptEl.value = tshirtState.prompt;
    if (negativePromptEl) negativePromptEl.value = tshirtState.negativePrompt;
    if (bgEl) bgEl.value = tshirtState.bg;
    if (modelEl) modelEl.value = tshirtState.model;
    if (sizeEl) sizeEl.value = tshirtState.size;

    if (promptEl) promptEl.oninput = (e) => tshirtState.prompt = e.target.value;
    if (negativePromptEl) negativePromptEl.oninput = (e) => tshirtState.negativePrompt = e.target.value;
    if (bgEl) bgEl.onchange = (e) => tshirtState.bg = e.target.value;
    if (modelEl) modelEl.onchange = (e) => tshirtState.model = e.target.value;
    if (sizeEl) sizeEl.onchange = (e) => tshirtState.size = e.target.value;
    if (lightingEl) lightingEl.oninput = (e) => {
      tshirtState.lighting = parseInt(e.target.value);
      document.getElementById('tshirt-lighting-val').textContent = tshirtState.lighting + '%';
    };
    if (whitepointEl) whitepointEl.oninput = (e) => {
      tshirtState.whitePoint = parseInt(e.target.value);
      document.getElementById('tshirt-whitepoint-val').textContent = tshirtState.whitePoint + '%';
    };

    // Wire up "Generate This Design Now" button
    const generateBtn = document.getElementById('tshirt-generate-single');
    if (generateBtn) {
      generateBtn.onclick = () => generateSingleDesign();
    }
  }, 0);

  return panel;
}

function renderBatchControls() {
  const panel = el('div', { class: 'panel' }, [
    el('h2', {}, 'Batch Controls'),
    el('div', { style: 'display:flex;flex-direction:column;gap:12px;' }, [
      el('div', { style: 'display:grid;grid-template-columns:repeat(3,1fr);gap:12px;' }, [
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Import CSV'),
          el('button', { class: 'btn', style: 'width:100%;' }, 'ðŸ“¤ CSV'),
          el('p', { style: 'font-size:11px;color:var(--muted);margin-top:4px;' }, 'Titles, prompts, variants')
        ]),
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Export Files'),
          el('button', { class: 'btn', style: 'width:100%;' }, 'ðŸ“¥ PNGs'),
          el('p', { style: 'font-size:11px;color:var(--muted);margin-top:4px;' }, 'All rendered images')
        ]),
        el('div', {}, [
          el('label', { style: 'font-size:12px;font-weight:600;display:block;margin-bottom:4px;' }, 'Zip Bundles'),
          el('button', { class: 'btn', style: 'width:100%;' }, 'ðŸ“¦ Per Product'),
          el('p', { style: 'font-size:11px;color:var(--muted);margin-top:4px;' }, 'For Printful uploads')
        ])
      ]),
      el('div', { style: 'display:flex;align-items:center;gap:12px;' }, [
        el('button', {
          id: 'tshirt-batch-btn',
          class: 'btn',
          style: `background:${tshirtState.running ? 'var(--muted)' : 'var(--accent)'};color:#fff;padding:12px 20px;font-weight:600;`
        }, tshirtState.running ? 'â¸ï¸ Pause' : 'â–¶ï¸ Start Batch'),
        el('div', { style: 'flex:1;' }, [
          el('div', {
            id: 'tshirt-progress-bar',
            style: `height:8px;background:var(--border);border-radius:4px;overflow:hidden;`
          }, [
            el('div', {
              id: 'tshirt-progress-fill',
              style: `height:100%;width:${tshirtState.progress}%;background:var(--accent);transition:width 0.3s;`
            })
          ]),
          el('div', {
            id: 'tshirt-progress-text',
            style: 'font-size:11px;color:var(--muted);margin-top:4px;'
          }, tshirtState.running ? `Renderingâ€¦ ${Math.round(tshirtState.progress)}%` : 'Idle')
        ])
      ])
    ])
  ]);

  // Wire up batch button
  setTimeout(() => {
    const batchBtn = document.getElementById('tshirt-batch-btn');
    if (batchBtn) {
      batchBtn.onclick = () => {
        if (tshirtState.running) {
          stopBatch();
        } else {
          startBatch();
        }
      };
    }
  }, 0);

  return panel;
}

function renderPreviewPanel() {
  const panel = el('div', { class: 'panel' }, [
    el('div', { style: 'display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;' }, [
      el('h2', { style: 'margin:0;' }, 'Preview'),
      el('span', { class: 'pill', style: 'background:var(--muted);color:#fff;font-size:11px;' }, 'Mock')
    ]),
    el('div', { style: 'display:flex;gap:4px;margin-bottom:12px;border-bottom:1px solid var(--border);' }, [
      el('button', {
        id: 'tshirt-tab-front',
        class: 'btn',
        style: `flex:1;padding:8px;border:none;border-bottom:2px solid ${tshirtState.previewTab === 'front' ? 'var(--accent)' : 'transparent'};background:transparent;font-weight:${tshirtState.previewTab === 'front' ? '600' : '400'};`
      }, 'Front'),
      el('button', {
        id: 'tshirt-tab-detail',
        class: 'btn',
        style: `flex:1;padding:8px;border:none;border-bottom:2px solid ${tshirtState.previewTab === 'detail' ? 'var(--accent)' : 'transparent'};background:transparent;font-weight:${tshirtState.previewTab === 'detail' ? '600' : '400'};`
      }, 'Detail'),
      el('button', {
        id: 'tshirt-tab-lifestyle',
        class: 'btn',
        style: `flex:1;padding:8px;border:none;border-bottom:2px solid ${tshirtState.previewTab === 'lifestyle' ? 'var(--accent)' : 'transparent'};background:transparent;font-weight:${tshirtState.previewTab === 'lifestyle' ? '600' : '400'};`
      }, 'Lifestyle')
    ]),
    el('div', { id: 'tshirt-preview-content', style: 'aspect-ratio:1;background:linear-gradient(135deg, var(--panel-bg) 0%, var(--border) 100%);border-radius:16px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;padding:24px;text-align:center;' })
  ]);

  // Set preview content
  setTimeout(() => {
    updatePreviewContent();

    const tabFront = document.getElementById('tshirt-tab-front');
    const tabDetail = document.getElementById('tshirt-tab-detail');
    const tabLifestyle = document.getElementById('tshirt-tab-lifestyle');

    if (tabFront) tabFront.onclick = () => { tshirtState.previewTab = 'front'; refreshTShirtUI(); };
    if (tabDetail) tabDetail.onclick = () => { tshirtState.previewTab = 'detail'; refreshTShirtUI(); };
    if (tabLifestyle) tabLifestyle.onclick = () => { tshirtState.previewTab = 'lifestyle'; refreshTShirtUI(); };
  }, 0);

  // Footer buttons with Accept/Reject
  const footer = el('div', { style: 'margin-top:12px;' });

  setTimeout(() => {
    const activeDesign = tshirtState.designQueue.find(d => d.id === tshirtState.activeDesign);

    footer.innerHTML = '';

    if (activeDesign && activeDesign.status === 'ready') {
      // Accept/Reject workflow
      const btnGroup = el('div', { style: 'display:flex;gap:8px;justify-content:space-between;' }, [
        el('button', {
          class: 'btn',
          style: 'background:var(--bad);color:#fff;flex:1;',
          onclick: () => rejectDesign(activeDesign.id)
        }, 'âŒ Reject'),
        el('button', {
          class: 'btn',
          style: 'background:var(--ok);color:#fff;flex:1;',
          onclick: () => acceptDesign(activeDesign.id)
        }, 'âœ… Accept')
      ]);

      const exportGroup = el('div', { style: 'display:flex;gap:8px;margin-top:8px;' }, [
        el('button', {
          class: 'btn',
          onclick: () => downloadDesign(activeDesign)
        }, 'ðŸ’¾ Download PNG'),
        el('button', {
          class: 'btn',
          style: 'background:var(--accent);color:#fff;',
          onclick: () => downloadMockup(activeDesign)
        }, 'ðŸ“¥ Download Mockup')
      ]);

      footer.appendChild(btnGroup);
      footer.appendChild(exportGroup);
    } else {
      footer.appendChild(el('div', { class: 'help', style: 'text-align:center;padding:12px;' }, 'Render a design to see accept/reject options'));
    }
  }, 0);

  panel.appendChild(footer);

  return panel;
}

function updatePreviewContent() {
  const previewContent = document.getElementById('tshirt-preview-content');
  if (!previewContent) return;

  const activeDesign = tshirtState.designQueue.find(d => d.id === tshirtState.activeDesign);
  const title = activeDesign?.title || 'No selection';

  previewContent.innerHTML = '';
  previewContent.style.padding = '0';

  if (!activeDesign || activeDesign.status === 'queued') {
    previewContent.style.padding = '24px';
    previewContent.appendChild(el('div', { style: 'font-size:48px;' }, 'â³'));
    previewContent.appendChild(el('p', { style: 'font-weight:600;' }, title));
    previewContent.appendChild(el('p', { style: 'font-size:12px;color:var(--muted);' }, activeDesign?.status === 'queued' ? 'Waiting to render...' : 'No design selected'));
    return;
  }

  if (activeDesign.status === 'error') {
    previewContent.style.padding = '24px';
    previewContent.appendChild(el('div', { style: 'font-size:48px;' }, 'âŒ'));
    previewContent.appendChild(el('p', { style: 'font-weight:600;color:var(--bad);' }, 'Generation Failed'));
    previewContent.appendChild(el('p', { style: 'font-size:12px;color:var(--muted);' }, activeDesign.error || 'Unknown error'));
    return;
  }

  // Show rendered images
  if (tshirtState.previewTab === 'front' && activeDesign.mockups && activeDesign.mockups.length > 0) {
    const frontMockup = activeDesign.mockups.find(m => m.placement === 'front') || activeDesign.mockups[0];
    const img = el('img', {
      src: frontMockup.url,
      style: 'width:100%;height:100%;object-fit:contain;border-radius:16px;',
      alt: 'T-shirt mockup'
    });
    previewContent.appendChild(img);
  } else if (tshirtState.previewTab === 'detail' && activeDesign.designUrl) {
    const img = el('img', {
      src: activeDesign.designUrl,
      style: 'width:100%;height:100%;object-fit:contain;border-radius:16px;background:var(--input-bg);',
      alt: 'Design detail'
    });
    previewContent.appendChild(img);
  } else if (tshirtState.previewTab === 'lifestyle' && activeDesign.mockups && activeDesign.mockups.length > 0) {
    const lifestyleMockup = activeDesign.mockups.find(m => m.placement === 'lifestyle') || activeDesign.mockups[0];
    const img = el('img', {
      src: lifestyleMockup.url,
      style: 'width:100%;height:100%;object-fit:contain;border-radius:16px;',
      alt: 'Lifestyle mockup'
    });
    previewContent.appendChild(img);
  } else {
    previewContent.style.padding = '24px';
    previewContent.appendChild(el('div', { style: 'font-size:48px;' }, 'ðŸ“¸'));
    previewContent.appendChild(el('p', { style: 'font-size:14px;color:var(--muted);' }, 'No preview available for this view'));
  }
}

function renderVariantsPanel() {
  const panel = el('div', { class: 'panel' }, [
    el('h2', {}, 'Variant Matrix'),
    el('div', { style: 'display:grid;grid-template-columns:repeat(2,1fr);gap:8px;' })
  ]);

  const variantsGrid = panel.querySelector('div:last-child');
  variants.forEach(v => {
    const variantBtn = el('button', {
      class: 'btn',
      style: 'text-align:left;padding:12px;'
    }, [
      el('div', { style: 'font-weight:600;font-size:14px;margin-bottom:4px;' }, v),
      el('div', { style: 'font-size:11px;color:var(--muted);' }, 'PNG â€¢ 2000Ã—2000 â€¢ Transparent')
    ]);
    variantsGrid.appendChild(variantBtn);
  });

  return panel;
}

function refreshTShirtUI() {
  // Re-render the entire T-Shirt Designer
  const content = document.getElementById('content');
  if (content && spec.appId === 'wescale-pod-console') {
    content.innerHTML = '';
    content.appendChild(renderTShirtDesigner());
  }
}

// Generate a single design immediately (no queue)
async function generateSingleDesign() {
  const generateBtn = document.getElementById('tshirt-generate-single');

  if (generateBtn) {
    generateBtn.disabled = true;
    generateBtn.textContent = 'â³ Generating...';
    generateBtn.style.background = 'var(--muted)';
  }

  try {
    toast('Generating design with DALL-E...');

    // Step 1: Generate design with DALL-E
    console.log('[T-Shirt Designer] Calling DALL-E with prompt:', tshirtState.prompt);
    const designResult = await apiCall('/api/generate-design', {
      method: 'POST',
      body: JSON.stringify({
        prompt: tshirtState.prompt,
        negativePrompt: tshirtState.negativePrompt,
        size: '1024x1024',
        style: 'natural'
      })
    });

    console.log('[T-Shirt Designer] DALL-E result:', designResult);
    toast('Design created! Generating mockup...');

    // Step 2: Generate mockup with Printful
    console.log('[T-Shirt Designer] Calling Printful mockup with image:', designResult.imageUrl);
    const mockupResult = await apiCall('/api/mockup', {
      method: 'POST',
      body: JSON.stringify({
        imageUrl: designResult.imageUrl,
        productId: 71,
        variantId: 4012
      })
    });

    console.log('[T-Shirt Designer] Mockup result:', mockupResult);

    // Create a new design object and add to queue
    const newDesign = {
      id: `design-${Date.now()}`,
      title: `${tshirtState.collection} â€” ${new Date().toLocaleTimeString()}`,
      brand: tshirtState.collection,
      aspect: tshirtState.size,
      bg: tshirtState.bg,
      model: tshirtState.model,
      status: 'ready',
      designUrl: designResult.imageUrl,
      revisedPrompt: designResult.revised_prompt,
      mockups: mockupResult.mockups || []
    };

    console.log('[T-Shirt Designer] Created design object:', newDesign);

    // Add to beginning of queue and make it active
    tshirtState.designQueue.unshift(newDesign);
    tshirtState.activeDesign = newDesign.id;

    console.log('[T-Shirt Designer] Design added to queue. Refreshing UI...');
    toast('âœ… Design complete! Check the preview panel â†’');
    refreshTShirtUI();

  } catch (error) {
    console.error('Single design generation failed:', error);
    toast('âŒ Generation failed: ' + error.message);
  } finally {
    if (generateBtn) {
      generateBtn.disabled = false;
      generateBtn.textContent = 'ðŸŽ¨ Generate This Design Now';
      generateBtn.style.background = 'var(--ok)';
    }
  }
}

async function startBatch() {
  tshirtState.running = true;
  tshirtState.progress = 0;

  const updateProgress = (pct, text) => {
    tshirtState.progress = pct;
    const progressFill = document.getElementById('tshirt-progress-fill');
    const progressText = document.getElementById('tshirt-progress-text');
    const batchBtn = document.getElementById('tshirt-batch-btn');

    if (progressFill) progressFill.style.width = pct + '%';
    if (progressText) progressText.textContent = text || `Renderingâ€¦ ${Math.round(pct)}%`;
    if (batchBtn) {
      batchBtn.textContent = 'â¸ï¸ Pause';
      batchBtn.style.background = 'var(--muted)';
    }
  };

  try {
    const queuedItems = tshirtState.designQueue.filter(d => d.status === 'queued');

    if (queuedItems.length === 0) {
      toast('No queued designs to render');
      stopBatch();
      return;
    }

    const total = queuedItems.length;

    for (let i = 0; i < queuedItems.length; i++) {
      if (!tshirtState.running) break; // User paused

      const design = queuedItems[i];
      const progressPct = (i / total) * 100;

      updateProgress(progressPct, `Generating design ${i + 1}/${total}...`);

      try {
        // Step 1: Generate design with DALL-E
        const designResult = await apiCall('/api/generate-design', {
          method: 'POST',
          body: JSON.stringify({
            prompt: tshirtState.prompt,
            negativePrompt: tshirtState.negativePrompt,
            size: '1024x1024',
            style: 'natural'
          })
        });

        design.designUrl = designResult.imageUrl;
        design.revisedPrompt = designResult.revised_prompt;

        updateProgress(progressPct + (30 / total), `Creating mockup ${i + 1}/${total}...`);

        // Step 2: Generate mockup with Printful
        const mockupResult = await apiCall('/api/mockup', {
          method: 'POST',
          body: JSON.stringify({
            imageUrl: design.designUrl,
            productId: 71,
            variantId: 4012
          })
        });

        design.mockups = mockupResult.mockups || [];
        design.status = 'ready';

        // Update the design in the queue
        const queueIdx = tshirtState.designQueue.findIndex(d => d.id === design.id);
        if (queueIdx !== -1) {
          tshirtState.designQueue[queueIdx] = design;
        }

        toast(`Design ${i + 1}/${total} complete!`);

      } catch (error) {
        console.error('Design generation failed:', error);
        design.status = 'error';
        design.error = error.message;
        toast(`Design ${i + 1} failed: ${error.message}`);
      }

      refreshTShirtUI();
    }

    updateProgress(100, 'Batch complete!');
    toast('All designs rendered!');

    setTimeout(() => stopBatch(), 1500);

  } catch (error) {
    console.error('Batch rendering error:', error);
    toast('Batch rendering failed: ' + error.message);
    stopBatch();
  }
}

function stopBatch() {
  tshirtState.running = false;
  if (batchInterval) {
    clearInterval(batchInterval);
    batchInterval = null;
  }

  const progressText = document.getElementById('tshirt-progress-text');
  const batchBtn = document.getElementById('tshirt-batch-btn');

  if (progressText) progressText.textContent = 'Idle';
  if (batchBtn) {
    batchBtn.textContent = 'â–¶ï¸ Start Batch';
    batchBtn.style.background = 'var(--accent)';
  }
}

// Accept/Reject workflow
function acceptDesign(designId) {
  const design = tshirtState.designQueue.find(d => d.id === designId);
  if (!design) return;

  design.accepted = true;
  design.rejected = false;
  toast(`âœ… Accepted: ${design.title}`);
  refreshTShirtUI();
}

function rejectDesign(designId) {
  const design = tshirtState.designQueue.find(d => d.id === designId);
  if (!design) return;

  design.rejected = true;
  design.accepted = false;
  design.status = 'rejected';
  toast(`âŒ Rejected: ${design.title}`);

  // Auto-select next queued design
  const nextQueued = tshirtState.designQueue.find(d => d.status === 'queued');
  if (nextQueued) {
    tshirtState.activeDesign = nextQueued.id;
  }

  refreshTShirtUI();
}

// Download functions
async function downloadDesign(design) {
  if (!design.designUrl) {
    toast('No design image available');
    return;
  }

  try {
    const response = await fetch(design.designUrl);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${design.id}_design.png`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Design downloaded!');
  } catch (error) {
    console.error('Download error:', error);
    toast('Download failed: ' + error.message);
  }
}

async function downloadMockup(design) {
  if (!design.mockups || design.mockups.length === 0) {
    toast('No mockup available');
    return;
  }

  try {
    const mockup = design.mockups[0];
    const response = await fetch(mockup.url);
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${design.id}_mockup.jpg`;
    a.click();
    URL.revokeObjectURL(url);
    toast('Mockup downloaded!');
  } catch (error) {
    console.error('Download error:', error);
    toast('Download failed: ' + error.message);
  }
}

// Batch export all accepted designs
async function exportAllAccepted() {
  const accepted = tshirtState.designQueue.filter(d => d.accepted && d.status === 'ready');

  if (accepted.length === 0) {
    toast('No accepted designs to export');
    return;
  }

  toast(`Downloading ${accepted.length} accepted designs...`);

  for (const design of accepted) {
    await downloadDesign(design);
    await new Promise(resolve => setTimeout(resolve, 500)); // Delay between downloads
  }

  toast('All accepted designs downloaded!');
}
</script>
</body>
</html>
